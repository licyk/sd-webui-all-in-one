name: Build All Portable

on:
  schedule:
  # * is a special character in YAML so you have to quote this string
  # UTC 17:00 -> CST (China) 1:00, see https://datetime360.com/cn/utc-cst-china-time/
  # https://docs.github.com/zh/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#schedule
  - cron: '0 16 * * 0'
  workflow_dispatch:

jobs:
  trigger-builds:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger build workflows
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflows = [
              'build_comfyui.yml',
              'build_fooocus.yml',
              'build_invokeai.yml',
              'build_kohya_gui.yml',
              'build_musubi_tuner.yml',
              'build_qwen_tts_webui.yml',
              'build_sd_next.yml',
              'build_sd_scripts.yml',
              'build_sd_trainer.yml',
              'build_sd_webui_forge_classic.yml',
              'build_sd_webui_forge.yml',
              'build_sd_webui_reforge.yml',
              'build_sd_webui.yml'
            ];

            const delay = 10 * 60 * 1000;

            for (let i = 0; i < workflows.length; i++) {
              const workflow = workflows[i];
              console.log(`正在触发整合包构建工作流 (${i + 1}/${workflows.length}): ${workflow}`);
              
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow,
                  ref: context.ref,
                });
                console.log(`成功触发: ${workflow}`);
              } catch (error) {
                console.error(`触发 ${workflow} 失败: ${error.message}`);
              }

              if (i < workflows.length - 1) {
                console.log(`等待 10 分钟后触发下一个...`);
                await new Promise(r => setTimeout(r, delay));
              }
            }
